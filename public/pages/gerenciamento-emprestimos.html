<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Devoluções</title>
  
  <link rel="stylesheet" href="../styles/style-global.css">
  <link rel="stylesheet" href="../styles/style-consultas.css">
  <link rel="icon" type="image/png" href="../images/favicon.ico">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  
  <h1>Gerenciamento de Devoluções</h1>
  <a href="menu.html" class="back-link">← Voltar ao Menu</a>
  
  <form id="form-busca-devolucao" class="container-busca">
    <svg class="icone-busca" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M10 2a8 8 0 1 0 5.657 13.657l5.385 5.385 1.414-1.414-5.385-5.385A8 8 0 0 0 10 2Zm0 2a6 6 0 1 1 0 12A6 6 0 0 1 10 4Z"></path>
    </svg>
    <input id="texto-busca" class="input-busca" type="text" placeholder="Buscar por aluno, livro ou código...">
  </form>

  <div class="container-tabela">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Aluno</th>
          <th>Livro</th>
          <th>Cód. Barras</th>
          <th>Data Emp.</th>
          <th>Prev. Devolução</th>
          <th>Status</th>
          <th style="width: 180px;">Ações</th>
        </tr>
      </thead>
      <tbody id="lista-emprestimos">
        </tbody>
    </table>
  </div>

  <script>
    const tableEmprestimos = document.getElementById("lista-emprestimos");

    function formatarData(dataISO) {
      if (!dataISO) return "-";
      const dataPura = dataISO.split('T')[0];
      const partes = dataPura.split("-");
      return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }

    // --- CARREGAR DADOS ---
    function carregarEmprestimos() {
      fetch('http://localhost:3000/api/emprestimos')
        .then(res => res.json())
        .then(data => {
            if(data.error) {
                console.error("Erro SQL:", data.error);
                return;
            }
            renderizarTabela(data);
        })
        .catch(err => console.error("Erro de conexão:", err));
    }

    function renderizarTabela(emprestimos) {
      tableEmprestimos.innerHTML = ""; 

      if (!emprestimos || emprestimos.length === 0) {
          tableEmprestimos.innerHTML = "<tr><td colspan='8' style='text-align:center; padding: 2rem;'>Nenhum histórico encontrado.</td></tr>";
          return;
      }

      emprestimos.forEach(emp => {
        let tr = document.createElement("tr");

        // Atraso
        const hoje = new Date().toISOString().split('T')[0];
        const dataPrevista = emp.data_prevista_devolucao ? emp.data_prevista_devolucao.split('T')[0] : "";
        let textoDataPrev = formatarData(emp.data_prevista_devolucao);
        
        if (emp.status === 'Ativo' && hoje > dataPrevista) {
            textoDataPrev = `<span class="texto-atrasado">${textoDataPrev} (Atrasado)</span>`;
        }

        // Status
        let htmlStatus = '';
        if (emp.status === 'Ativo') {
            htmlStatus = `<span class="status-badge status-ativo">Emprestado</span>`;
        } else {
            htmlStatus = `<span class="status-badge status-devolvido">Devolvido</span>`;
        }

        // Botões
        let btnAcao = '';
        if (emp.status === 'Ativo') {
            btnAcao = `
                <button class="btn-pequeno" style="background-color:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;" onclick="devolver(${emp.id})">
                    <i class="fa-solid fa-rotate-left"></i> Devolver
                </button>
            `;
        } else {
            btnAcao = `<span style="color: #28a745; font-weight:bold; font-size: 0.9rem; margin-right: 10px;"><i class="fa-solid fa-check"></i> OK</span>`;
        }

        const btnExcluir = `
            <button class="btn-pequeno" style="background-color:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer;" onclick="excluir(${emp.id})">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;

        tr.innerHTML = `
           <td>${emp.id}</td>
           <td>${emp.nome_aluno}</td>
           <td>${emp.nome_livro}</td>
           <td>${emp.codigo_de_barras}</td>
           <td>${formatarData(emp.data_emprestimo)}</td>
           <td>${textoDataPrev}</td>
           <td>${htmlStatus}</td>
           <td style="white-space: nowrap;">
              ${btnAcao}
              ${btnExcluir}
           </td>
        `;
        tableEmprestimos.appendChild(tr);
      });
    }

    // --- AÇÕES ---
    function devolver(id) {
        if(!confirm("Confirmar a devolução deste livro?")) return;
        fetch(`http://localhost:3000/api/emprestimos/${id}/devolver`, { method: 'PUT' })
        .then(res => res.json())
        .then(() => { alert("Livro devolvido com sucesso!"); carregarEmprestimos(); });
    }

    function excluir(id) {
        if(!confirm("Tem certeza que deseja apagar este registro do histórico?")) return;
        fetch(`http://localhost:3000/api/emprestimos/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(() => carregarEmprestimos());
    }

    // --- BUSCA ---
    const campoBusca = document.getElementById("texto-busca");
    campoBusca.addEventListener("input", function () {
      const texto = this.value.toLowerCase();
      const linhas = document.querySelectorAll("#lista-emprestimos tr");
      linhas.forEach(tr => {
        if(tr.cells.length < 2) return;
        const aluno = tr.cells[1].textContent.toLowerCase();
        const livro = tr.cells[2].textContent.toLowerCase();
        const codigo = tr.cells[3].textContent.toLowerCase();
        if (aluno.includes(texto) || livro.includes(texto) || codigo.includes(texto)) {
          tr.style.display = "";
        } else {
          tr.style.display = "none";
        }
      });
    });

    document.getElementById("form-busca-devolucao").addEventListener("submit", e => e.preventDefault());

    carregarEmprestimos();
  </script>

</body>
</html>