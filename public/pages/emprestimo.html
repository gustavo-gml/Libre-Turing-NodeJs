<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Empréstimo - Libre Turing</title>
    
    <link rel="stylesheet" href="../styles/style-global.css">
    <link rel="stylesheet" href="../styles/style-emprestimos.css">
    <link rel="icon" type="image/png" href="../images/favicon.ico">
</head>
<body>
    <div class="container">
        <a href="menu.html" class="back-link">← Voltar ao Menu</a>
        
        <h2>Realizar Empréstimo</h2>
        <p class="subtitle">
            Busque o livro e o aluno digitando nome, código ou CPF.
        </p>
        
        <form id="form-emprestimo">

            <label for="input-livro">Buscar Livro (Nome, ISBN ou Cód. Barras):</label>
            <input type="text" list="lista-livros" id="input-livro" placeholder="Digite para buscar..." required autocomplete="off">
            <datalist id="lista-livros"></datalist>
            <input type="hidden" id="id-exemplar-selecionado">

            <label for="input-aluno">Buscar Aluno (Nome ou RA):</label>
            <input type="text" list="lista-alunos" id="input-aluno" placeholder="Digite para buscar..." required autocomplete="off">
            <datalist id="lista-alunos"></datalist>
            <input type="hidden" id="ra-aluno-selecionado">

            <label for="data-devolucao">Devolução Prevista:</label>
            <input type="date" id="data-devolucao" required>

            <button type="submit">Confirmar Empréstimo</button>

        </form> 
    </div>

    <script>
        let listaGlobalLivros = [];
        let listaGlobalAlunos = [];

        async function carregarDados() {
            try {
                // Carrega Acervo
                const resLivros = await fetch('http://localhost:3000/api/acervo');
                const livros = await resLivros.json();
                
                // Carrega Alunos
                const resAlunos = await fetch('http://localhost:3000/api/alunos');
                const alunos = await resAlunos.json();

                // DEBUG: Mostra no console o que chegou do servidor
                console.log("Livros carregados:", livros); 
                console.log("Alunos carregados:", alunos);

                listaGlobalLivros = livros;
                listaGlobalAlunos = alunos;

                popularDatalists();

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                alert("Erro de conexão. Verifique o console (F12) para detalhes.");
            }
        }

        function popularDatalists() {
            const datalistLivros = document.getElementById("lista-livros");
            const datalistAlunos = document.getElementById("lista-alunos");

            datalistLivros.innerHTML = "";
            datalistAlunos.innerHTML = "";

            // Filtra disponíveis
            const disponiveis = listaGlobalLivros.filter(item => item.status === 'Disponível');

            disponiveis.forEach(item => {
                const option = document.createElement("option");
                
                // Tenta pegar os valores, se não existirem usa string vazia para não dar erro
                const nome = item.nome_livro || item.titulo || "Sem Título";
                const cod = item.codigo_de_barras || item.codigo || "S/N";
                const isbn = item.isbn || "";

                option.value = `${nome} (Cód: ${cod}) - ISBN: ${isbn}`;
                option.setAttribute("data-id", item.id_exemplar || item.id); // Tenta id_exemplar ou id
                
                datalistLivros.appendChild(option);
            });

            listaGlobalAlunos.forEach(aluno => {
                const option = document.createElement("option");
                option.value = `${aluno.nome_aluno} (RA: ${aluno.ra})`;
                option.setAttribute("data-ra", aluno.ra);
                datalistAlunos.appendChild(option);
            });
        }
        
        // Lógica de Seleção Livro
        document.getElementById('input-livro').addEventListener('change', function() {
            const valor = this.value;
            const opcao = Array.from(document.getElementById('lista-livros').options)
                               .find(opt => opt.value === valor);
            
            if (opcao) {
                document.getElementById('id-exemplar-selecionado').value = opcao.getAttribute('data-id');
                this.classList.add('input-sucesso');
                this.classList.remove('input-erro');
            } else {
                document.getElementById('id-exemplar-selecionado').value = "";
                this.classList.add('input-erro');
                this.classList.remove('input-sucesso');
            }
        });

        // Lógica de Seleção Aluno
        document.getElementById('input-aluno').addEventListener('change', function() {
            const valor = this.value;
            const opcao = Array.from(document.getElementById('lista-alunos').options)
                               .find(opt => opt.value === valor);
            
            if (opcao) {
                document.getElementById('ra-aluno-selecionado').value = opcao.getAttribute('data-ra');
                this.classList.add('input-sucesso');
                this.classList.remove('input-erro');
            } else {
                document.getElementById('ra-aluno-selecionado').value = "";
                this.classList.add('input-erro');
                this.classList.remove('input-sucesso');
            }
        });

        // Envio do Formulário
        document.getElementById("form-emprestimo").addEventListener("submit", function (e) {
            e.preventDefault();

            const idExemplar = document.getElementById("id-exemplar-selecionado").value;
            const raAluno = document.getElementById("ra-aluno-selecionado").value;
            const dataDev = document.getElementById("data-devolucao").value;
            const dataHoje = new Date().toISOString().split('T')[0];

            if (!idExemplar || !raAluno) {
                alert("Erro: Selecione um livro e um aluno válidos da lista (clique na opção sugerida).");
                return;
            }

            if (new Date(dataDev) < new Date(dataHoje)) {
                alert("Erro: Data de devolução inválida.");
                return;
            }

            const payload = {
                id_exemplar: idExemplar,
                id_funcionario: 1, // Garanta que existe ID 1 na tabela funcionarios
                ra_aluno: raAluno,
                data_emprestimo: dataHoje,
                data_prevista_devolucao: dataDev
            };

            fetch('http://localhost:3000/api/emprestimos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(async res => {
                const data = await res.json(); // Lê o JSON da resposta
                if (!res.ok) {
                    // Se deu erro (500), joga pro catch com a mensagem do servidor
                    throw new Error(data.error || "Erro desconhecido no servidor");
                }
                return data;
            })
            .then(data => {
                alert("Sucesso! " + data.message);
                document.getElementById("form-emprestimo").reset();
                document.getElementById("id-exemplar-selecionado").value = "";
                document.getElementById("ra-aluno-selecionado").value = "";
                document.getElementById('input-livro').classList.remove('input-sucesso');
                document.getElementById('input-aluno').classList.remove('input-sucesso');
                carregarDados();
            })
            .catch(err => {
                console.error(err);
                // AQUI VAI APARECER O MOTIVO REAL DO ERRO
                alert("Erro ao realizar empréstimo:\n" + err.message);
            });
        });

        carregarDados();
    </script>
</body>
</html>